$schema: 'http://json-schema.org/draft-04/schema#'
title: 'Network protocol'
description: >
  Protocol for starting and stopping FBP networks, and finding out
  about their state.

output:
  stopped:
    id: 'output/stopped'
    description: 'Inform that a given network has stopped.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['stopped']
          payload:
            required: ['time', 'uptime', 'graph']
            additionalProperties: false
            properties:
              time:
                type: 'string'
                format: 'date-time'
                description: 'time when the network was stopped'
              uptime:
                type: number
                description: 'time the network was running, in seconds'
              graph:
                type: "string"
                description: 'graph the action targets'

  started:
    id: 'output/started'
    description: 'Inform that a given network has been started.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['started']
          payload:
            required: ['time', 'graph']
            additionalProperties: false
            properties:
              time:
                type: "string"
                format: "date-time"
                description: 'time when the network was started'
              graph:
                type: "string"
                description: 'graph the action targets'

  status:
    id: 'output/status'
    description: 'Response to a getstatus message.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['status']
          payload:
            required: ['running', 'graph', 'uptime']
            additionalProperties: false
            properties:
              running:
                type: boolean
                description: 'boolean tells whether the network is running or not'
              graph:
                type: string
                description: 'graph the action targets'
              uptime:
                type: number
                description: '(optional) time the network has been running, in seconds'

  output:
    id: 'output/output'
    description: >
      An output message from a running network, roughly similar to STDOUT output
      of a Unix process, or a line of console.log in JavaScript. Output can also
      be used for passing images from the runtime to the UI.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['output']
          payload:
            required: ['message']
            additionalProperties: false
            properties:
              message:
                type: "string"
                description: 'contents of the output line'
              type:
                type: "string"
                enum: ["message", "previewurl"]
                description: '(optional) type of output, either message or previewurl'
              url:
                type: "string"
                format: "uri"
                description: '(optional) URL for an image generated by the runtime'

  error:
    id: 'output/error'
    description: >
      An error from a running network, roughly similar to STDERR
      output of a Unix process, or a line of console.error in JavaScript.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['error']
          payload:
            required: ['message']
            additionalProperties: false
            properties:
              message:
                description: 'contents of the error message'

  icon:
    id: 'output/icon'
    description: 'Icon of a component instance has changed.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['icon']
          payload:
            required: ['id', 'icon', 'graph']
            additionalProperties: false
            properties:
              id:
                type: "string"
                description: 'identifier of the node'
              icon:
                type: "string"
                description: 'new icon for the component instance'
              graph:
                type: "string"
                description: 'graph the action targets'

  connect:
    id: 'output/connect'
    description: 'Beginning of transmission on an edge.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['connect']
          payload:
            $ref: '/shared/network_event'
            additionalProperties: false

  begingroup:
    id: 'output/begingroup'
    description: 'Beginning of a group (bracket IP) on an edge.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['begingroup']
          payload:
            allOf:
              - $ref: '/shared/network_event'
              - required: ['group']
                properties:
                  group:
                    description: 'group name'
                    type: "string"
              - additionalProperties: false
                properties:
                  group: true
                  id: true
                  tgt: true
                  src: true
                  graph: true
                  subgraph: true

  data:
    id: 'output/data'
    description: 'Data transmission on an edge.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['data']
          payload:
            allOf:
              - $ref: '/shared/network_event'
              - required: ['data']
                properties:
                  data:
                    description: >
                      actual data being transmitted, encoded in a way
                      that can be carried over the protocol transport
              - additionalProperties: false
                properties:
                  data: true
                  id: true
                  src: true
                  tgt: true
                  graph: true
                  subgraph: true

  endgroup:
    id: 'output/endgroup'
    description: 'Ending of a group (bracket IP) on an edge.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['endgroup']
          payload:
            allOf:
              - $ref: '/shared/network_event'
              - required: ['group']
                properties:
                  group:
                    description: 'group name'
                    type: "string"
              - additionalProperties: false
                properties:
                  group: true
                  id: true
                  src: true
                  tgt: true
                  graph: true
                  subgraph: true

  disconnect:
    id: 'output/disconnect'
    description: 'End of transmission on an edge.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['disconnect']
          payload:
            $ref: '/shared/network_event'
            additionalProperties: false

input:
  error:
    id: 'input/error'
    description: 'Network error'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['error']

  start:
    id: 'input/start'
    description: 'Start execution of a FBP network based on a given graph.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['start']
          payload:
            required: ['graph']
            additionalProperties: false
            properties:
              graph:
                type: "string"
                description: 'graph the action targets'

  getstatus:
    id: 'input/getstatus'
    description: >
      Get the current status of the runtime. The runtime should
      respond with a status message.
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['getstatus']
          payload:
            required: ['graph']
            additionalProperties: false
            properties:
              graph:
                type: "string"
                description: 'graph the action targets'

  stop:
    id: 'input/stop'
    description: 'Stop execution of a FBP network based on a given graph.'
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['stop']
          payload:
            required: ['graph']
            additionalProperties: false
            properties:
              graph:
                type: "string"
                description: 'graph the action targets'

  edges:
    id: 'input/edges'
    description: >
      List of edges user has selected for inspection in a user
      interface or debugger, sent from UI to a runtime.
    allOf:
      - $ref: '/shared/message'
      - properties:
          protocol:
            enum: ['network']
          command:
            enum: ['edges']
          payload:
            required: ['edges']
            additionalProperties: false
            properties:
              edges:
                type: array
                description: 'list of selected edges, each containing'
                items:
                  type: object
                  required: ['src', 'tgt']
                  additionalProperties: false
                  properties:
                    src:
                      description: 'source node for the edge'
                      $ref: '/shared/port'
                    tgt:
                      description: 'target node for the edge'
                      $ref: '/shared/port'

